{% extends 'base.html' %}

{% block title %}M-Pesa Payment - Checkout{% endblock %}

{% block content %}
<form id="payment-form" class="needs-validation" novalidate>
    {% csrf_token %}
    <div class="row g-2">
        <div class="col-12">
            <label for="phone_number" class="form-label mb-1">
                <i class="fas fa-phone"></i> Phone Number
            </label>
            <input type="tel" class="form-control form-control-sm" id="phone_number" 
                   name="phone_number" placeholder="07XXXXXXXX" required>
            <div class="form-text small">Enter your phone number</div>
            <div class="invalid-feedback">Please enter a valid phone number</div>
        </div>
        
        <div class="col-12 mt-2">
            <label for="amount" class="form-label mb-1">
                <i class="fas fa-money-bill-wave"></i> Amount
            </label>
            <div class="input-group input-group-sm">
                <span class="input-group-text">KES</span>
                <input type="text" class="form-control" id="amount" 
                       name="amount" placeholder="10" required inputmode="numeric" pattern="[0-9,]*">
            </div>
            <div class="form-text small">1 - 300,000</div>
            <div class="invalid-feedback">Please enter a valid amount</div>
        </div>
        
        <div class="col-md-6 mt-2">
            <label for="reference" class="form-label mb-1">
                <i class="fas fa-hashtag"></i> Reference
            </label>
            <input type="text" class="form-control form-control-sm" id="reference" 
                   name="reference" placeholder="INV001" maxlength="40">
            <div class="form-text small">Optional</div>
        </div>
        
        <div class="col-md-6 mt-2">
            <label for="description" class="form-label mb-1">
                <i class="fas fa-comment-alt"></i> Description
            </label>
            <input type="text" class="form-control form-control-sm" id="description" 
                   name="description" placeholder="Payment for..." maxlength="100">
            <div class="form-text small">Optional</div>
        </div>
    </div>
    
    <div class="d-grid mt-3">
        <button type="submit" class="btn btn-mpesa btn-lg" id="pay-btn">
            <i class="fas fa-credit-card me-2"></i>
            <span>Pay with M-Pesa</span>
        </button>
    </div>
    
    <div class="text-center mt-2">
        <small class="text-muted">
            <i class="fas fa-shield-alt me-1"></i>
            Secured by 256-bit SSL encryption
        </small>
    </div>
</form>

<!-- Payment Status Modal -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title mb-0">
                    <i class="fas fa-mobile-alt me-2"></i>
                    Payment Status
                </h6>
            </div>
            <div class="modal-body text-center py-3">
                <div id="status-content">
                    <!-- Status content will be dynamically inserted here -->
                </div>
                
                <!-- Progress Container -->
                <div class="progress-container" id="progress-container" style="display: none;">
                    <div class="progress mb-2" style="height: 6px;">
                        <div class="progress-bar" role="progressbar" style="width: 0%" 
                             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" id="progress-bar"></div>
                    </div>
                    <div class="timer-display" id="timer-display">Checking payment status...</div>
                    <div class="text-muted small mt-1">
                        <i class="fas fa-info-circle me-1"></i>
                        Complete payment on your phone
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 justify-content-center py-2" id="modal-footer">
                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal" id="close-btn" style="display: none;">
                    <i class="fas fa-times me-2"></i>Close
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    /**
     * M-Pesa Payment Processing Class
     */
    class MpesaPayment {
        constructor() {
            this.maxRetries = 8; // Reduced to 8 since we're checking every 15 seconds (2 minutes total)
            this.retryCount = 0;
            this.checkoutRequestId = null;
            this.statusCheckInterval = null;
            this.progressInterval = null;
            this.timeoutId = null;
            this.redirectTimer = null; // Timer for auto-redirect countdown
            this.isChecking = false; // Flag to prevent concurrent checks
            this.isFormLocked = false; // Flag to track form lock state
            this.initializeEventListeners();
        }

        initializeEventListeners() {
            const form = document.getElementById('payment-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const isValid = this.validateForm();
                if (isValid) {
                    this.initiatePayment();
                } else {
                    form.classList.add('was-validated');
                    const firstInvalid = form.querySelector(':invalid');
                    if (firstInvalid) {
                        firstInvalid.focus();
                    }
                    this.showError('Please correct the errors in the form');
                }
            });

            const phoneInput = document.getElementById('phone_number');
            phoneInput.addEventListener('input', this.formatPhoneNumber.bind(this));
            phoneInput.addEventListener('blur', this.validatePhoneNumber.bind(this));

            const amountInput = document.getElementById('amount');
            amountInput.addEventListener('input', this.formatAmount.bind(this));
            amountInput.addEventListener('blur', this.validateAmount.bind(this));
            amountInput.addEventListener('keypress', this.handleAmountKeypress.bind(this));
            amountInput.addEventListener('paste', this.handleAmountPaste.bind(this));

            this.setupModalEventDelegation();
        }

        setupModalEventDelegation() {
            const modal = document.getElementById('statusModal');
            modal.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const buttonId = target.id;
                console.log('Modal button clicked:', buttonId);

                // Prevent actions during active status checking unless it's a cancellation action
                if (this.isChecking && !['cancel-tryagain-btn', 'timeout-startover-btn', 'new-payment-btn', 'close-modal-btn'].includes(buttonId)) {
                    console.log('Action blocked: Status check in progress');
                    this.showError('Please wait until the current check completes or cancel the payment');
                    return;
                }

                switch (buttonId) {
                    case 'cancel-tryagain-btn':
                        console.log('Processing cancellation try again');
                        this.stopChecking();
                        this.unlockForm();
                        bootstrap.Modal.getInstance(modal).hide();
                        this.resetForm();
                        break;
                    case 'timeout-recheck-btn':
                    case 'recheck-btn':
                    case 'retry-recheck-btn':
                        console.log('Processing recheck status');
                        this.recheckStatus();
                        break;
                    case 'timeout-startover-btn':
                    case 'new-payment-btn':
                        console.log('Processing start over');
                        this.stopChecking();
                        this.unlockForm();
                        bootstrap.Modal.getInstance(modal).hide();
                        this.resetForm();
                        break;
                    case 'close-modal-btn':
                        console.log('Processing modal close');
                        this.stopChecking();
                        this.unlockForm();
                        bootstrap.Modal.getInstance(modal).hide();
                        break;
                    case 'close-btn':
                        console.log('Processing success close');
                        // Clear auto-redirect timer when user manually clicks
                        if (this.redirectTimer) {
                            clearTimeout(this.redirectTimer);
                            this.redirectTimer = null;
                        }
                        if (this.checkoutRequestId) {
                            window.location.href = `/payments/status/${this.checkoutRequestId}/`;
                        } else {
                            this.unlockForm();
                            bootstrap.Modal.getInstance(modal).hide();
                            this.resetForm();
                        }
                        break;
                    default:
                        console.log('Unknown button clicked:', buttonId);
                }
            });
            console.log('Modal event delegation setup complete');
        }

        validateForm() {
            const phoneInput = document.getElementById('phone_number');
            const amountInput = document.getElementById('amount');
            let isValid = true;

            if (!this.isValidPhoneNumber(phoneInput.value)) {
                phoneInput.setCustomValidity('Please enter a valid phone number');
                isValid = false;
            } else {
                phoneInput.setCustomValidity('');
            }

            const amount = parseFloat(amountInput.value.replace(/,/g, ''));
            if (!amount || amount < 1 || amount > 300000) {
                amountInput.setCustomValidity('Amount must be between 1 and 300,000');
                isValid = false;
            } else {
                amountInput.setCustomValidity('');
            }

            return isValid;
        }

        isValidPhoneNumber(phone) {
            const cleanPhone = phone.replace(/\D/g, '');
            if (cleanPhone.length === 10 && /^0[17]\d{8}$/.test(cleanPhone)) {
                return true;
            }
            if (cleanPhone.length === 12 && /^254[17]\d{8}$/.test(cleanPhone)) {
                return true;
            }
            return false;
        }

        validatePhoneNumber(e) {
            const input = e.target;
            if (input.value && !this.isValidPhoneNumber(input.value)) {
                input.setCustomValidity('Please enter a valid phone number (07XX XXX XXX, 01XX XXX XXX, or +254 XXX XXX XXX)');
            } else {
                input.setCustomValidity('');
            }
        }

        validateAmount(e) {
            const input = e.target;
            const amount = parseFloat(input.value.replace(/,/g, ''));
            if (input.value && (!amount || amount < 1 || amount > 300000)) {
                input.setCustomValidity('Amount must be between 1 and 300,000');
            } else {
                input.setCustomValidity('');
            }
        }

        handleAmountKeypress(e) {
            // Allow: backspace, delete, tab, escape, enter
            if ([8, 9, 27, 13, 46].indexOf(e.keyCode) !== -1 ||
                // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                (e.keyCode === 65 && e.ctrlKey === true) ||
                (e.keyCode === 67 && e.ctrlKey === true) ||
                (e.keyCode === 86 && e.ctrlKey === true) ||
                (e.keyCode === 88 && e.ctrlKey === true)) {
                return;
            }
            // Ensure that it is a number and stop the keypress
            if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                e.preventDefault();
            }
        }

        handleAmountPaste(e) {
            e.preventDefault();
            const paste = (e.clipboardData || window.clipboardData).getData('text');
            const numericValue = paste.replace(/[^\d]/g, '');
            
            if (numericValue) {
                const input = e.target;
                input.value = numericValue;
                // Trigger formatting
                this.formatAmount(e);
            }
        }

        formatPhoneNumber(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.startsWith('254')) {
                if (value.length > 12) value = value.slice(0, 12);
                if (value.length >= 6) {
                    value = `+254 ${value.slice(3, 6)} ${value.slice(6, 9)} ${value.slice(9)}`.trim();
                } else if (value.length >= 3) {
                    value = `+254 ${value.slice(3)}`;
                } else {
                    value = `+${value}`;
                }
            } else if (value.startsWith('0')) {
                if (value.length > 10) value = value.slice(0, 10);
                if (value.length >= 4) {
                    value = `${value.slice(0, 4)} ${value.slice(4, 7)} ${value.slice(7)}`.trim();
                }
            } else if (value.length > 0) {
                value = '0' + value;
                if (value.length > 10) value = value.slice(0, 10);
                if (value.length >= 4) {
                    value = `${value.slice(0, 4)} ${value.slice(4, 7)} ${value.slice(7)}`.trim();
                }
            }
            e.target.value = value;
        }

        formatAmount(e) {
            const input = e.target;
            const cursorPosition = input.selectionStart;
            const oldValue = input.value;
            
            // Extract only digits
            let value = input.value.replace(/[^\d]/g, '');
            
            // If empty, just return
            if (!value) {
                return;
            }
            
            // Prevent leading zeros (except for single zero)
            if (value.length > 1 && value.startsWith('0')) {
                value = value.replace(/^0+/, '');
            }
            
            // Convert to number and check bounds
            let numValue = parseInt(value, 10);
            
            // If the number exceeds maximum, cap it at 300000
            if (numValue > 300000) {
                numValue = 300000;
                value = numValue.toString();
            }
            
            // Format with commas as thousands separator
            let formattedValue = '';
            if (numValue > 0) {
                formattedValue = numValue.toLocaleString('en-US');
            }
            
            // Only update if the value actually changed
            if (input.value !== formattedValue) {
                input.value = formattedValue;
                
                // Try to maintain cursor position
                const newLength = formattedValue.length;
                const oldLength = oldValue.length;
                const newCursorPosition = Math.min(cursorPosition + (newLength - oldLength), newLength);
                
                // Set cursor position after a small delay to ensure the value is set
                setTimeout(() => {
                    try {
                        input.setSelectionRange(newCursorPosition, newCursorPosition);
                    } catch (e) {
                        // Ignore cursor position errors
                    }
                }, 0);
            }
        }

        async initiatePayment() {
            const formData = new FormData(document.getElementById('payment-form'));
            const payBtn = document.getElementById('pay-btn');
            const btnText = payBtn.querySelector('span');
            const phoneInput = document.getElementById('phone_number');
            const cleanPhone = this.normalizePhoneNumber(phoneInput.value);
            formData.set('phone_number', cleanPhone);
            const amountInput = document.getElementById('amount');
            const cleanAmount = amountInput.value.replace(/,/g, '');
            formData.set('amount', cleanAmount);

            this.lockForm();

            try {
                const response = await fetch('/payments/checkout/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                });
                const data = await response.json();
                if (response.ok && data.ResponseCode === "0") {
                    this.checkoutRequestId = data.CheckoutRequestID;
                    this.showStatusModal();
                    this.startStatusChecking();
                } else {
                    this.unlockForm();
                    this.showError(data.errorMessage || data.ResponseDescription || 'Payment initiation failed');
                }
            } catch (error) {
                this.unlockForm();
                this.showError('Network error. Please check your connection and try again.');
                console.error('Payment error:', error);
            }
        }

        lockForm() {
            this.isFormLocked = true;
            const payBtn = document.getElementById('pay-btn');
            const btnText = payBtn.querySelector('span');
            
            payBtn.disabled = true;
            btnText.innerHTML = '<span class="loading-spinner me-2"></span>Connecting to M-Pesa...';
            payBtn.classList.add('loading');
            
            // Add pulsing effect to button
            payBtn.style.animation = 'pulse 1.5s infinite';
            
            // Disable form inputs
            const inputs = document.querySelectorAll('#payment-form input');
            inputs.forEach(input => {
                input.disabled = true;
                input.style.opacity = '0.6';
            });
            
            // Show progress toast
            this.showProgressToast('Initiating payment request...');
        }

        unlockForm() {
            this.isFormLocked = false;
            const payBtn = document.getElementById('pay-btn');
            const btnText = payBtn.querySelector('span');
            
            payBtn.disabled = false;
            btnText.innerHTML = 'Pay with M-Pesa';
            payBtn.classList.remove('loading');
            payBtn.style.animation = '';
            
            // Re-enable form inputs
            const inputs = document.querySelectorAll('#payment-form input');
            inputs.forEach(input => {
                input.disabled = false;
                input.style.opacity = '1';
            });
        }

        normalizePhoneNumber(phone) {
            let cleanPhone = phone.replace(/\D/g, '');
            if (cleanPhone.startsWith('0')) {
                cleanPhone = '254' + cleanPhone.slice(1);
            } else if (cleanPhone.startsWith('254')) {
                // Already in correct format
            } else if (cleanPhone.length === 9) {
                cleanPhone = '254' + cleanPhone;
            }
            return cleanPhone;
        }

        showStatusModal() {
            const modal = new bootstrap.Modal(document.getElementById('statusModal'));
            document.getElementById('status-content').innerHTML = `
            <div class="status-pending mb-3">
                <div class="status-icon">
                    <div class="position-relative">
                        <i class="fas fa-mobile-alt fa-3x text-primary"></i>
                        <div class="position-absolute top-0 start-100 translate-middle">
                            <span class="badge bg-success rounded-pill animate-pulse">
                                <i class="fas fa-bell fa-xs"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            <h5 class="fw-bold mb-2">Payment Request Sent</h5>
            <p class="text-muted mb-3 small">Check your phone for M-Pesa prompt and enter PIN</p>
            
            <!-- Compact Step Indicator -->
            <div class="payment-steps mb-3">
                <div class="d-flex justify-content-center align-items-center gap-2 mb-2">
                    <div class="step-item active">
                        <div class="step-circle bg-success text-white" style="width: 35px; height: 35px;">
                            <i class="fas fa-paper-plane" style="font-size: 0.8rem;"></i>
                        </div>
                        <small class="step-label text-success" style="font-size: 0.7rem;">Sent</small>
                    </div>
                    <div class="step-connector active" style="width: 40px; height: 2px;"></div>
                    <div class="step-item pending">
                        <div class="step-circle bg-warning text-dark" style="width: 35px; height: 35px;">
                            <i class="fas fa-mobile-alt" style="font-size: 0.8rem;"></i>
                        </div>
                        <small class="step-label text-warning" style="font-size: 0.7rem;">Waiting</small>
                    </div>
                    <div class="step-connector" style="width: 40px; height: 2px;"></div>
                    <div class="step-item">
                        <div class="step-circle bg-light text-muted" style="width: 35px; height: 35px;">
                            <i class="fas fa-check" style="font-size: 0.8rem;"></i>
                        </div>
                        <small class="step-label text-muted" style="font-size: 0.7rem;">Complete</small>
                    </div>
                </div>
            </div>
        `;
            document.getElementById('progress-container').style.display = 'block';
            document.getElementById('close-btn').style.display = 'none';
            modal.show();
        }

        startStatusChecking() {
            this.retryCount = 0;
            this.isChecking = true; // Set checking flag
            this.startProgress();
            this.statusCheckInterval = setInterval(() => {
                this.checkPaymentStatus();
            }, 15000); // Increased to 15 seconds to respect M-Pesa rate limits (4 requests per minute)
            this.timeoutId = setTimeout(() => {
                this.handleTimeout();
            }, 120000); // Increased timeout to 2 minutes to accommodate slower checking
        }

        startProgress() {
            let progress = 0;
            let stepCount = 0;
            const progressBar = document.getElementById('progress-bar');
            const timerDisplay = document.getElementById('timer-display');
            
            // Progress steps with messages
            const progressSteps = [
                { threshold: 10, message: "Sending payment request to M-Pesa..." },
                { threshold: 25, message: "Waiting for your response on phone..." },
                { threshold: 50, message: "Verifying payment with M-Pesa..." },
                { threshold: 75, message: "Processing payment confirmation..." },
                { threshold: 90, message: "Finalizing transaction..." }
            ];
            
            this.progressInterval = setInterval(() => {
                progress += (100 / 120); // Adjusted for 120 seconds (2 minutes)
                if (progress > 100) progress = 100;
                
                progressBar.style.width = progress + '%';
                progressBar.setAttribute('aria-valuenow', progress);
                
                const remainingTime = Math.max(0, 120 - Math.floor(progress * 120 / 100));
                
                // Update message based on progress
                let currentMessage = "Checking payment status...";
                for (const step of progressSteps) {
                    if (progress >= step.threshold && stepCount < progressSteps.indexOf(step) + 1) {
                        currentMessage = step.message;
                        stepCount = progressSteps.indexOf(step) + 1;
                        break;
                    }
                }
                
                timerDisplay.innerHTML = `
                    <div class="fw-medium small">${currentMessage}</div>
                    <small class="text-muted" style="font-size: 0.75rem;">(${remainingTime}s remaining)</small>
                `;
                
                if (progress >= 100) {
                    clearInterval(this.progressInterval);
                    timerDisplay.innerHTML = `
                        <div class="fw-medium small">Completing verification...</div>
                        <small class="text-muted" style="font-size: 0.75rem;">Please wait</small>
                    `;
                }
            }, 1000);
        }

        async checkPaymentStatus() {
            if (!this.checkoutRequestId) {
                console.error('No checkoutRequestId available');
                this.stopChecking();
                this.showError('Invalid transaction ID. Please start a new payment.');
                return;
            }

            this.retryCount++;
            console.log(`Payment status check attempt ${this.retryCount}/${this.maxRetries}`);
            console.log(`Making STK query for: ${this.checkoutRequestId}`);

            try {
                const requestBody = {
                    checkout_request_id: this.checkoutRequestId
                };
                console.log('STK Query Request Body:', requestBody);

                const response = await fetch('/payments/stk-query/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('STK Query Response Status:', response.status);
                console.log('STK Query Response Headers:', Object.fromEntries(response.headers.entries()));

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`HTTP error! status: ${response.status}, response: ${errorText}`);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('STK Query Response Data:', data);

                // Check for backend errors first
                if (data.error) {
                    console.error('Backend error:', data.error);
                    
                    // Check for rate limiting specifically
                    if (data.error.includes('Spike arrest violation') || data.error.includes('rate')) {
                        console.warn('Rate limit hit, increasing retry interval');
                        // Don't count rate limit as a regular retry
                        this.retryCount = Math.max(0, this.retryCount - 1);
                        return; // Will retry on next interval
                    }
                    
                    if (this.retryCount >= this.maxRetries) {
                        this.handleTimeout();
                        return;
                    }
                    console.log('Backend error, will retry...');
                    return;
                }

                // Check local transaction status first
                if (data.local_transaction) {
                    const localStatus = data.local_transaction.status;
                    console.log('Local transaction status:', localStatus);
                    console.log('Local transaction data:', data.local_transaction);
                    
                    if (localStatus === "0") {
                        console.log('Payment successful from local transaction');
                        this.handleSuccess(data);
                        return;
                    } else if (localStatus === "2") {
                        console.log('Payment failed from local transaction');
                        this.handleCancellation(data, 'failed');
                        return;
                    } else if (localStatus === "3") {
                        console.log('Payment cancelled from local transaction');
                        this.handleCancellation(data, 'cancelled');
                        return;
                    } else if (localStatus === "4") {
                        console.log('Payment timeout from local transaction');
                        this.handleCancellation(data, 'timeout');
                        return;
                    }
                    // Status "1" means pending, continue to check M-Pesa API
                }

                // Check M-Pesa API response
                if (data.ResultCode !== undefined) {
                    const resultCode = data.ResultCode.toString();
                    console.log('M-Pesa ResultCode:', resultCode);
                    console.log('M-Pesa ResultDesc:', data.ResultDesc);
                    
                    if (resultCode === "0") {
                        console.log('Payment successful from M-Pesa API');
                        this.handleSuccess(data);
                        return;
                    } else if (resultCode === "1032" || resultCode === "1037" || resultCode === "1" || resultCode === "17") {
                        console.log('Payment cancelled/failed from M-Pesa API, code:', resultCode);
                        let reason = 'cancelled';
                        if (resultCode === "1037") reason = 'timeout';
                        else if (resultCode === "1" || resultCode === "17") reason = 'failed';
                        this.handleCancellation(data, reason);
                        return;
                    } else if (resultCode === "1001" || resultCode === "4999") {
                        console.log('Payment still pending, will retry... Code:', resultCode);
                    } else {
                        console.log('Payment failed with error code:', resultCode);
                        this.handleCancellation(data, 'failed');
                        return;
                    }
                } else {
                    console.log('No ResultCode in response, payment likely still pending');
                }

                // Check for max retries
                if (this.retryCount >= this.maxRetries) {
                    console.log('Max retries reached, timing out...');
                    this.handleTimeout();
                    return;
                }

                console.log('Continuing to check payment status...');
            } catch (error) {
                console.error('Status check error:', error);
                console.error('Error details:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                
                if (this.retryCount >= this.maxRetries) {
                    console.log('Max retries reached due to errors, timing out...');
                    this.handleTimeout();
                } else {
                    this.showError('Temporary network issue. Retrying...');
                }
            }
        }

        handleSuccess(data) {
            this.stopChecking();
            this.unlockForm();
            this.showSuccessToast('Payment completed successfully!');
            
            document.getElementById('status-content').innerHTML = `
            <div class="status-success mb-3">
                <div class="status-icon">
                    <i class="fas fa-check-circle fa-3x text-success"></i>
                </div>
            </div>
            <h5 class="text-success fw-bold mb-2">Payment Successful!</h5>
            <p class="text-muted mb-2 small">Payment processed successfully. SMS confirmation coming.</p>
            <div class="bg-light rounded p-2 mb-2">
                <small class="text-muted d-block" style="font-size: 0.7rem;">Transaction ID</small>
                <strong class="text-dark small">${this.checkoutRequestId || 'N/A'}</strong>
            </div>
            
            <!-- Compact Success Steps -->
            <div class="payment-steps mb-2">
                <div class="d-flex justify-content-center align-items-center gap-1">
                    <div class="step-item active">
                        <div class="step-circle bg-success text-white" style="width: 25px; height: 25px;">
                            <i class="fas fa-paper-plane" style="font-size: 0.6rem;"></i>
                        </div>
                    </div>
                    <div class="step-connector active" style="width: 30px; height: 2px;"></div>
                    <div class="step-item active">
                        <div class="step-circle bg-success text-white" style="width: 25px; height: 25px;">
                            <i class="fas fa-mobile-alt" style="font-size: 0.6rem;"></i>
                        </div>
                    </div>
                    <div class="step-connector active" style="width: 30px; height: 2px;"></div>
                    <div class="step-item active">
                        <div class="step-circle bg-success text-white" style="width: 25px; height: 25px;">
                            <i class="fas fa-check" style="font-size: 0.6rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-center">
                <p class="text-muted small mb-0">Redirecting in <span id="redirect-countdown">3</span>s...</p>
            </div>
        `;
            document.getElementById('progress-container').style.display = 'none';
            document.getElementById('close-btn').style.display = 'block';
            document.getElementById('close-btn').className = 'btn btn-success';
            document.getElementById('close-btn').innerHTML = '<i class="fas fa-receipt me-2"></i>View Transaction';
            console.log('Success state set up');
            
            // Auto-redirect after 3 seconds with countdown
            this.startRedirectCountdown();
        }

        handleCancellation(data, reason = 'cancelled') {
            this.stopChecking();
            this.unlockForm();
            
            let message, icon, title;
            
            // Use M-Pesa's actual ResultDesc if available
            const mpesaMessage = data.ResultDesc || '';
            
            switch (reason) {
                case 'timeout':
                    title = 'Payment Timeout';
                    message = mpesaMessage || 'The payment request timed out. Please try again.';
                    icon = 'fas fa-clock fa-4x text-warning';
                    break;
                case 'failed':
                    title = 'Payment Failed';
                    message = mpesaMessage || 'Your payment could not be processed. Please check your M-Pesa account and try again.';
                    icon = 'fas fa-exclamation-triangle fa-4x text-danger';
                    break;
                case 'cancelled':
                default:
                    title = 'Payment Cancelled';
                    message = mpesaMessage || 'You cancelled the payment request. No money has been deducted from your account.';
                    icon = 'fas fa-times-circle fa-4x text-warning';
                    break;
            }
            
            // Override with specific M-Pesa result codes and their descriptions
            if (data.ResultCode) {
                const resultCode = data.ResultCode.toString();
                if (resultCode === "1037") {
                    title = 'Payment Timeout';
                    message = data.ResultDesc || 'No response from user. The payment request timed out.';
                    icon = 'fas fa-clock fa-4x text-warning';
                } else if (resultCode === "1" || resultCode === "17") {
                    title = 'Insufficient Funds';
                    message = data.ResultDesc || 'Insufficient funds in your M-Pesa account. Please top up and try again.';
                    icon = 'fas fa-wallet fa-4x text-danger';
                } else if (resultCode === "1032") {
                    title = 'Payment Cancelled';
                    message = data.ResultDesc || 'You cancelled the payment on your phone.';
                    icon = 'fas fa-times-circle fa-4x text-warning';
                } else if (resultCode === "1025") {
                    title = 'Invalid Phone Number';
                    message = data.ResultDesc || 'The phone number provided is not valid for M-Pesa.';
                    icon = 'fas fa-phone-slash fa-4x text-danger';
                } else if (resultCode === "1001") {
                    title = 'Payment Pending';
                    message = data.ResultDesc || 'Payment is still being processed.';
                    icon = 'fas fa-hourglass-half fa-4x text-info';
                }
            }
            
            console.log(`Payment ${reason}:`, data);
            document.getElementById('status-content').innerHTML = `
            <div class="status-failed mb-3">
                <div class="status-icon">
                    <i class="${icon}"></i>
                </div>
            </div>
            <h5 class="text-warning fw-bold mb-2">${title}</h5>
            <p class="text-muted mb-2 small">${message}</p>
            
            ${data.ResultCode ? `
            <div class="alert alert-light border py-1 px-2 mb-2">
                <small class="text-muted d-block mb-1" style="font-size: 0.7rem;">M-Pesa Code</small>
                <strong class="text-dark small">${data.ResultCode}</strong>
            </div>
            ` : ''}
            
            <div class="text-center mb-2">
                <button class="btn btn-outline-primary btn-sm" id="cancel-tryagain-btn">
                    <i class="fas fa-redo me-1"></i>Try Again
                </button>
            </div>
            <div class="text-center">
                <p class="text-muted small mb-0">Returning in <span id="failure-countdown">4</span>s... 
                    <button class="btn btn-link btn-sm p-0 text-decoration-underline" style="font-size: 0.7rem;" onclick="window.mpesaPayment.stopChecking()">Cancel</button>
                </p>
            </div>
        `;
            document.getElementById('progress-container').style.display = 'none';
            document.getElementById('close-btn').style.display = 'block';
            document.getElementById('close-btn').className = 'btn btn-outline-secondary';
            document.getElementById('close-btn').innerHTML = '<i class="fas fa-times me-2"></i>Close';
            
            // Auto-redirect to payment form after 4 seconds
            this.startFailureRedirectCountdown();
        }

        handleTimeout() {
            this.stopChecking();
            this.unlockForm();
            document.getElementById('status-content').innerHTML = `
            <div class="status-failed mb-3">
                <div class="status-icon">
                    <i class="fas fa-clock fa-3x text-warning"></i>
                </div>
            </div>
            <h5 class="text-warning fw-bold mb-2">Payment Timeout</h5>
            <p class="text-muted mb-2 small">Took too long to complete. Payment may still be processing.</p>
            <div class="alert alert-warning py-2 px-2 mb-2">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <small>If you completed payment, click "Check Again"</small>
            </div>
            <div class="d-flex gap-2 justify-content-center">
                <button class="btn btn-outline-primary btn-sm" id="timeout-recheck-btn">
                    <i class="fas fa-sync me-1"></i>Check Again
                </button>
                <button class="btn btn-outline-secondary btn-sm" id="timeout-startover-btn">
                    <i class="fas fa-redo me-1"></i>Start Over
                </button>
            </div>
        `;
            document.getElementById('progress-container').style.display = 'none';
            document.getElementById('close-btn').style.display = 'block';
            document.getElementById('close-btn').className = 'btn btn-outline-secondary';
            document.getElementById('close-btn').innerHTML = '<i class="fas fa-times me-2"></i>Close';
        }

        async recheckStatus() {
            console.log('recheckStatus called');
            if (!this.checkoutRequestId) {
                this.showError('No checkout request ID found');
                this.resetForm();
                return;
            }
            if (this.isChecking) {
                this.showError('Please wait until the current check completes');
                return;
            }

            this.isChecking = true;
            console.log('Starting recheck for:', this.checkoutRequestId);
            document.getElementById('status-content').innerHTML = `
            <div class="status-pending mb-3">
                <div class="status-icon">
                    <div class="spinner-border text-primary" role="status" style="width: 2.5rem; height: 2.5rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <h5 class="fw-bold mb-2">Rechecking Payment</h5>
            <p class="text-muted small">Verifying your payment status...</p>
        `;
            document.getElementById('close-btn').style.display = 'none';

            try {
                const response = await fetch('/payments/stk-query/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        checkout_request_id: this.checkoutRequestId
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Recheck Response:', data);
                this.retryCount = 0;

                if (data.local_transaction) {
                    const localStatus = data.local_transaction.status;
                    console.log('Recheck - Local transaction status:', localStatus);
                    if (localStatus === "0") {
                        console.log('Recheck - Payment successful from local transaction');
                        this.handleSuccess(data);
                        return;
                    } else if (localStatus === "2") {
                        console.log('Recheck - Payment failed from local transaction');
                        this.handleCancellation(data, 'failed');
                        return;
                    } else if (localStatus === "3") {
                        console.log('Recheck - Payment cancelled from local transaction');
                        this.handleCancellation(data, 'cancelled');
                        return;
                    } else if (localStatus === "4") {
                        console.log('Recheck - Payment timeout from local transaction');
                        this.handleCancellation(data, 'timeout');
                        return;
                    }
                    // Status "1" means pending, continue to check M-Pesa API
                }

                if (data.ResultCode) {
                    const resultCode = data.ResultCode.toString();
                    console.log('Recheck - M-Pesa ResultCode:', resultCode);
                    if (resultCode === "0") {
                        console.log('Recheck - Payment successful from M-Pesa API');
                        this.handleSuccess(data);
                        return;
                    } else if (resultCode === "1032" || resultCode === "1037" || resultCode === "1" || resultCode === "17") {
                        console.log('Recheck - Payment cancelled/failed from M-Pesa API');
                        let reason = 'cancelled';
                        if (resultCode === "1037") reason = 'timeout';
                        else if (resultCode === "1" || resultCode === "17") reason = 'failed';
                        this.handleCancellation(data, reason);
                        return;
                    }
                }

                console.log('Recheck - Payment still pending');
                this.handleRecheckResult(data);
            } catch (error) {
                console.error('Recheck error:', error);
                this.showError('Failed to check payment status. Please try again.');
                this.handleRecheckError();
            } finally {
                this.isChecking = false; // Reset checking flag
            }
        }

        handleRecheckResult(data) {
            this.unlockForm(); // Unlock form when recheck shows still pending
            document.getElementById('status-content').innerHTML = `
            <div class="status-failed mb-3">
                <div class="status-icon">
                    <i class="fas fa-clock fa-3x text-warning"></i>
                </div>
            </div>
            <h5 class="text-warning fw-bold mb-2">Still Pending</h5>
            <p class="text-muted mb-2 small">Payment still processing. Can take a few minutes.</p>
            <div class="d-flex gap-2 justify-content-center mb-2">
                <button class="btn btn-outline-primary btn-sm" id="recheck-btn">
                    <i class="fas fa-sync me-1"></i>Check Again
                </button>
                <button class="btn btn-outline-secondary btn-sm" id="new-payment-btn">
                    <i class="fas fa-redo me-1"></i>New Payment
                </button>
            </div>
        `;
            document.getElementById('close-btn').style.display = 'block';
            document.getElementById('close-btn').className = 'btn btn-outline-secondary';
            document.getElementById('close-btn').innerHTML = '<i class="fas fa-times me-2"></i>Close';
            this.isChecking = false; // Reset checking flag
        }

        handleRecheckError() {
            this.unlockForm(); // Unlock form on recheck error
            document.getElementById('status-content').innerHTML = `
            <div class="status-failed mb-3">
                <div class="status-icon">
                    <i class="fas fa-exclamation-triangle fa-3x text-danger"></i>
                </div>
            </div>
            <h5 class="text-danger fw-bold mb-2">Check Failed</h5>
            <p class="text-muted mb-2 small">Unable to verify due to network error.</p>
            <div class="d-flex gap-2 justify-content-center">
                <button class="btn btn-outline-primary btn-sm" id="retry-recheck-btn">
                    <i class="fas fa-sync me-1"></i>Try Again
                </button>
                <button class="btn btn-outline-secondary btn-sm" id="close-modal-btn">
                    <i class="fas fa-times me-1"></i>Close
                </button>
            </div>
        `;
            document.getElementById('close-btn').style.display = 'block';
            document.getElementById('close-btn').className = 'btn btn-outline-secondary';
            document.getElementById('close-btn').innerHTML = '<i class="fas fa-times me-2"></i>Close';
            this.isChecking = false; // Reset checking flag
        }

        showError(message) {
            const toastHtml = `
            <div class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
            this.showToast(toastHtml);
        }

        showProgressToast(message) {
            const toastHtml = `
            <div class="toast align-items-center text-white bg-info border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-info-circle me-2"></i>
                        ${message}
                    </div>
                </div>
            </div>
        `;
            this.showToast(toastHtml, 2000);
        }

        showSuccessToast(message) {
            const toastHtml = `
            <div class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-check-circle me-2"></i>
                        ${message}
                    </div>
                </div>
            </div>
        `;
            this.showToast(toastHtml, 3000);
        }

        showToast(toastHtml, autoHideDelay = 5000) {
            let toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = toastContainer.lastElementChild;
            const toast = new bootstrap.Toast(toastElement, {
                autohide: true,
                delay: autoHideDelay
            });
            toast.show();
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        stopChecking() {
            if (this.statusCheckInterval) {
                clearInterval(this.statusCheckInterval);
                this.statusCheckInterval = null;
            }
            if (this.progressInterval) {
                clearInterval(this.progressInterval);
                this.progressInterval = null;
            }
            if (this.timeoutId) {
                clearTimeout(this.timeoutId);
                this.timeoutId = null;
            }
            if (this.redirectTimer) {
                clearTimeout(this.redirectTimer);
                this.redirectTimer = null;
            }
            this.isChecking = false; // Reset checking flag
        }

        resetForm() {
            this.stopChecking();
            this.unlockForm();
            const form = document.getElementById('payment-form');
            form.reset();
            form.classList.remove('was-validated');
            const inputs = form.querySelectorAll('input');
            inputs.forEach(input => {
                input.setCustomValidity('');
            });
            this.checkoutRequestId = null;
            this.retryCount = 0;
            console.log('Form and payment state reset successfully');
        }

        startRedirectCountdown() {
            let countdown = 3;
            const countdownElement = document.getElementById('redirect-countdown');
            
            const updateCountdown = () => {
                if (countdownElement) {
                    countdownElement.textContent = countdown;
                }
                
                if (countdown <= 0) {
                    // Redirect to transaction status page
                    if (this.checkoutRequestId) {
                        console.log('Auto-redirecting to transaction status page');
                        window.location.href = `/payments/status/${this.checkoutRequestId}/`;
                    }
                    return;
                }
                
                countdown--;
                this.redirectTimer = setTimeout(updateCountdown, 1000);
            };
            
            // Start the countdown after 1 second
            this.redirectTimer = setTimeout(updateCountdown, 1000);
        }

        startFailureRedirectCountdown() {
            let countdown = 4;
            const countdownElement = document.getElementById('failure-countdown');
            
            const updateCountdown = () => {
                if (countdownElement) {
                    countdownElement.textContent = countdown;
                }
                
                if (countdown <= 0) {
                    // Close modal and reset form to allow new payment
                    console.log('Auto-redirecting to payment form after failure');
                    const modal = document.getElementById('statusModal');
                    bootstrap.Modal.getInstance(modal).hide();
                    this.resetForm();
                    return;
                }
                
                countdown--;
                this.redirectTimer = setTimeout(updateCountdown, 1000);
            };
            
            // Start the countdown after 1 second
            this.redirectTimer = setTimeout(updateCountdown, 1000);
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        window.mpesaPayment = new MpesaPayment();
    });
</script>
{% endblock %}